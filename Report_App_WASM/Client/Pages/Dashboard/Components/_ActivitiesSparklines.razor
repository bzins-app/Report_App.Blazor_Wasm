@using Report_App_WASM.Shared.ApiExchanges
@using ApexCharts
<MudTable Items="_taskLogs!.GroupBy(e => e.ActivityName).OrderByDescending(a=>a.Sum(taksLogsValues=>taksLogsValues.NbrTasks))" Height="460px" Virtualize="true" Breakpoint="Breakpoint.Sm" HorizontalScrollbar="true" FixedHeader="true" Dense="true">
    <HeaderContent>
        <MudTh>@Localizer.Get("Activity")</MudTh>
        <MudTh>@Localizer.Get("Nbr of tasks over the last 10 days")</MudTh>
        <MudTh>@Localizer.Get("Type of tasks")</MudTh>
        <MudTh>@Localizer.Get("Tasks per day")</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>@context.Key</MudTd>
        <MudTd>@context.Sum(a=>a.NbrTasks)</MudTd>
        <MudTd>
            <ApexChart TItem="TaksLogsValues"
                       Width="30"
                       Height="30"
                       Options="GetPieOptions()">

                <ApexPointSeries TItem="TaksLogsValues"
                                 Items="context.ToList()"
                                 Name="@Localizer.Get("Type of tasks")"
                                 SeriesType="SeriesType.Pie"
                                 XValue="@(e => e.TypeTask)"
                                 YAggregate="@(e => e.Sum(a=>a.NbrTasks))" />

            </ApexChart>
        </MudTd>
        <MudTd>
            <ApexChart TItem="TaksLogsValues"
                       XAxisType="XAxisType.Datetime"
                       Options="GetBarOptions()"
                       Height="30"
                       Width="150">

                <ApexPointSeries TItem="TaksLogsValues"
                                 Items="context.ToList()"
                                 Name="@Localizer.Get("Tasks per day")"
                                 SeriesType="SeriesType.Bar"
                                 XValue="@(e => e.Date.ToLocalTime())"
                                 YAggregate="@(e => e.Count())"
                                 OrderBy="e=>e.X" />
            </ApexChart>
        </MudTd>
    </RowTemplate>
</MudTable>

@code {
    private List<TaksLogsValues>? _taskLogs = new();

    protected override async Task OnInitializedAsync()
    {
        _taskLogs = await DataService.GetValues<TaksLogsValues>("TasksLogs", "api/Dashboard/");
    }

    private ApexChartOptions<TaksLogsValues> GetPieOptions()
    {
        var options = new ApexChartOptions<TaksLogsValues>();
        options.Stroke = new() { Width = 1 };
        options.Tooltip = new() { Fixed = new() { Enabled = false } };
        options.Chart = new() { Sparkline = new(), Animations = new() { Enabled = false } };
        options.PlotOptions = new() { Pie = new() { ExpandOnClick = false } };
        return options;
    }

    private ApexChartOptions<TaksLogsValues> GetBarOptions()
    {
        var options = new ApexChartOptions<TaksLogsValues>();
        options.Chart = new() { Sparkline = new(), Animations = new() { Enabled = false } };
        options.PlotOptions = new() { Bar = new() { ColumnWidth = "85%", } };
        options.Tooltip = new() { X = new() { Format = @" dd \ MM \ yyyy" } };

        return options;
    }

    //private ApexChartOptions<ApplicationLogTaskDTO> GetBarOptionsHour()
    //{
    //	var options = new ApexCharts.ApexChartOptions<ApplicationLogTaskDTO>();
    //	options.Chart = new Chart { Sparkline = new ChartSparkline(),Animations= new Animations {Enabled=false} };
    //	options.PlotOptions = new PlotOptions { Bar = new PlotOptionsBar { ColumnWidth = "85%", } };
    //	options.Tooltip = new ApexCharts.Tooltip { X = new TooltipX { Format = @"HH:MIN" } };

    //	return options;
    //}

}
