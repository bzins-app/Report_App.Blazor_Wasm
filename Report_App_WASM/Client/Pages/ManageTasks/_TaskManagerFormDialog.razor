
<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@(Action==CrudAction.Update? Icons.Material.Filled.Edit:Action==CrudAction.Create?Icons.Material.Filled.Create:Icons.Material.Filled.DeleteForever )" Class="mr-3 mb-n1" />
            @localizer.Get(Action == CrudAction.Update ? "Edit" : Action == CrudAction.Create ? "Add" : "Delete")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm Model="@Item" @ref="@form">
            <MudTextField @bind-Value="Item.TaskName" Label="@(Item.TypeName==TaskType.Report.ToString()? localizer.Get("Report title"):Item.TypeName==TaskType.DataTransfer.ToString()?  localizer.Get("Job title"): localizer.Get("Alert title"))" Required RequiredError="@localizer.Get("Required")" Disabled="Action==CrudAction.Delete?true:false" />
            <MudSelect T="string" Label="@localizer.Get("Activity name")" @bind-Value="@Item.ActivityName" AnchorOrigin="Origin.BottomCenter"
                       Required RequiredError="@localizer.Get("Required")" Disabled="Action==CrudAction.Delete?true:false">
                @foreach (var value in activities)
                {
                    <MudSelectItem Value="@value.ActivityName">@value.ActivityName</MudSelectItem>
                }
            </MudSelect>
            @if (Item.TypeName == TaskType.Report.ToString())
            {
                <MudSelect  Label="@localizer.Get("Type of file")" @bind-Value="@Item.TypeFile" AnchorOrigin="Origin.BottomCenter"
                       Required RequiredError="@localizer.Get("Required")" Disabled="Action==CrudAction.Delete?true:false">
                    @foreach (FileType item in Enum.GetValues(typeof(FileType)))
                    {
                        <MudSelectItem Value="@item">@item</MudSelectItem>
                    }
                </MudSelect>
            }
        </MudForm>
        @if (Action == CrudAction.Delete)
        {
                <MudTextField @bind-Value="deletionValidation" Label="@(localizer.Get("Confirm the deletion by entering")+": Validate")" Required RequiredError="@localizer.Get("Required")" />
        }
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Info" OnClick="Cancel">@localizer.Get("Cancel")</MudButton>
        <MudButton Color="Action==CrudAction.Delete?Color.Error:Color.Primary" OnClick="Validate">@localizer.Get(Action==CrudAction.Delete?"Delete":"Validate")</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }

    [Parameter] public TaskHeaderDTO Item { get; set; }
    [Parameter] public CrudAction Action { get; set; }
    private MudForm form = default!;
    private string deletionValidation;
    private List<SelectItemActivitiesInfo> activities = new();

    protected override async Task OnInitializedAsync()
    {
        activities = await dataService.GetValues<SelectItemActivitiesInfo>("ActivitiesInfo", ApiControllers.ApplicationParametersApi);
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task Validate()
    {
        if (Action == CrudAction.Delete)
        {
            if (deletionValidation == "Validate")
            {
                Item.Activity = new ActivityDTO { ActivityId = activities.Where(a => a.ActivityName == Item.ActivityName).Select(a => a.ActivityId).FirstOrDefault(), ActivityName = Item.ActivityName };
                MudDialog.Close(DialogResult.Ok(Item));
            }
        }
        else
        {
            Item.Activity = new ActivityDTO { ActivityId=activities.Where(a=>a.ActivityName==Item.ActivityName).Select(a=>a.ActivityId).FirstOrDefault(), ActivityName=Item.ActivityName};
            Item.IdActivity = Item.Activity.ActivityId;
            await form.Validate();
            if (form.IsValid&&Item.Activity is not null)
            {
                
                MudDialog.Close(DialogResult.Ok(Item));
            }
        }
    }
}