@using Report_App_WASM.Client.Shared.Theme
@inherits LayoutComponentBase
@inject HttpClient Http
@inject IJSRuntime JsInterop
@attribute [Authorize]

<MudThemeProvider IsDarkMode="_isDarkMode" Theme="_appTheme" />
<MudDialogProvider FullWidth="true"
                   MaxWidth="MaxWidth.Small"
                   CloseButton="true"
                   DisableBackdropClick="true"
                   Position="DialogPosition.Center"
                   CloseOnEscapeKey="false" />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Color="Color.Surface">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@DrawerToggle" />
        <img src="@ApplicationConstants.ApplicationLogo" alt="@ApplicationConstants.ApplicationName" style="padding-left:10px;max-width: 95%;max-height: 55px;" />
        <MudSpacer />
        <MudTooltip Duration="1000" Text="@(_isDarkMode ? Localizer.Get("Switch to Light Theme") : Localizer.Get("Switch to Dark Theme"))">
            <MudIconButton Icon="@(_isDarkMode ? Icons.Rounded.LightMode : Icons.Material.Outlined.DarkMode)" Color="Color.Inherit" OnClick="@(()=>DarkModeChange(!UserAppTheme.DarkTheme))" />
        </MudTooltip>
        <LanguageSwitch />
        <LoginDisplay />
    </MudAppBar>
    <AuthorizeView>
        <Authorized>
            <MudDrawer @bind-Open="DrawerOpen" Elevation="25" ClipMode="DrawerClipMode.Never">
                <NavMenu  IsDarkMode="_isDarkMode" />
            </MudDrawer>
        </Authorized>
    </AuthorizeView>
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.False" Class="mt-4" Style="padding-bottom:10px">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>
@code{
    private string? UserName { get; set; }
    readonly MudTheme _appTheme = ApplicationTheme.ApplicationMudTheme();

    private bool _isDarkMode;
    public bool DrawerOpen = true;

    protected override async Task OnInitializedAsync()
    {
        var values =await  Http.GetFromJsonAsync<ApplicationConstantsValues>($"{ApiControllers.ApplicationParametersApi}ApplicationConstants");
        ApplicationConstants.ApplicationLogo = values?.ApplicationLogo;
        ApplicationConstants.ApplicationName = values?.ApplicationName;
        ApplicationConstants.LdapLogin = values!.LdapLogin;
        _isDarkMode=UserAppTheme.DarkTheme;
    }

    void DrawerToggle()
    {
        DrawerOpen = !DrawerOpen;
    }

    private async Task DarkModeChange(bool dark)
    {
        _isDarkMode = dark;
        UserAppTheme.DarkTheme = dark;
        if (!dark)
        {
            await JsInterop.InvokeVoidAsync("AppTheme.set", "Light");
        }
        else
        {
            await JsInterop.InvokeVoidAsync("AppTheme.set", "Dark");
        }
    }
}