@using System.Runtime.InteropServices.ComTypes
@using Microsoft.EntityFrameworkCore.Metadata.Internal

<MudDialog>
    <DialogContent>
        <MudForm @ref="@_form">
            <MudCard>
                <MudCardContent>
                    <MudText Typo="Typo.body2">@Localizer.Get("Emails")</MudText>
                    @if (RecipientsEmails.Count > 0)
                    {
                        <MudStack Row="true">
                            <p>@Localizer.Get("Send for me")</p>
                            <MudSwitch @bind-Checked="@SendForReportRecipients" Color="Color.Primary" />
                            <p>@Localizer.Get("Send for all recipients")</p>
                        </MudStack>
                    }
                    @if (!SendForReportRecipients)
                    {
                        foreach (string str in UserEmail)
                        {
                            <MudTextField Value="str" Label="@Localizer.Get("Email")" Disabled />
                        }
                    }
                    else
                    {
                        foreach (string str in RecipientsEmails)
                        {
                            <MudTextField Value="str" Label="@Localizer.Get("Email")" Disabled />
                        }
                    }
                </MudCardContent>
            </MudCard>
            @if (QueryParameters.Any())
            {
                <MudCard>
                    <MudCardContent>
                        <MudText Typo="Typo.body2">@Localizer.Get("Query parameters")</MudText>
                        @foreach (QueryCommandParameter t in QueryParameters)
                        {
                            @if (t.ValueType == QueryCommandParameterValueType.Date)
                            {
                                <MudTextField InputType="InputType.Date" Required="@t.Required" Format="yyyy-MM-dd" @bind-Value="t.value" Label="@t.ParameterIdentifier" />
                            }
                            @if (t.ValueType == QueryCommandParameterValueType.DateTime)
                            {
                                <MudTextField InputType="InputType.DateTimeLocal" Required="@t.Required" Format="s" @bind-Value="t.value" Label="@t.ParameterIdentifier" />
                            }
                            @if (t.ValueType == QueryCommandParameterValueType.Number)
                            {
                                <MudTextField InputType="InputType.Number" @bind-Value="t.value" Required="@t.Required" Label="@t.ParameterIdentifier" />
                            }
                            @if (t.ValueType == QueryCommandParameterValueType.String)
                            {
                                <MudTextField InputType="InputType.Text" @bind-Value="t.value" Required="@t.Required" Label="@t.ParameterIdentifier" />
                            }
                        }
                    </MudCardContent>
                </MudCard>
            }
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@Localizer.Get("Cancel")</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ConfirmText" Class="px-10">@Localizer.Get("Validate")</MudButton>
    </DialogActions>
</MudDialog>


@code {

    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    public bool SendForReportRecipients { get; set; }
    private MudForm _form = default!;
    [Parameter]
    public List<string> UserEmail { get; set; }
    [Parameter]
    public List<QueryCommandParameter> QueryParameters { get; set; }
    [Parameter]
    public List<string> RecipientsEmails { get; set; }


    protected override void OnInitialized()
    {
        foreach (var t in QueryParameters.Where(t => t.ValueType == QueryCommandParameterValueType.Date || t.ValueType == QueryCommandParameterValueType.DateTime))
        {
            if (t.ValueType == QueryCommandParameterValueType.Date)
            {
                t.value = t.DateOption.GetCalculateDateTime().Date.ToString("yyyy-MM-dd");
            }
            if (t.ValueType == QueryCommandParameterValueType.DateTime)
            {
                t.value = t.DateOption.GetCalculateDateTime().ToString("s");
            }
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }


    private async Task ConfirmText()
    {
        await _form.Validate();
        if (_form.IsValid)
        {
            Tuple<bool, List<QueryCommandParameter>> payload = new Tuple<bool, List<QueryCommandParameter>>(SendForReportRecipients, QueryParameters);
            MudDialog.Close(DialogResult.Ok(payload));
        }
    }
}